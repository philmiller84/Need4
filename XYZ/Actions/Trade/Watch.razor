@page "/trade/watch/{tradeId:int}/{userId:int}"

@using Helpers
@inject IAuthorizationService AuthorizationService
@inject IHttpContextAccessor HttpContextAccessor

<h3>WatchTrade</h3>

@if (authorization.Result.Succeeded)
{
    <p>Have permission</p>
    <p> called with variables:</p>
    <p> tradeId: @tradeId </p>
    <p> userId: @userId </p>
}
else
{
    <p>DONT Have permission</p>
}

@code {
    [Parameter]
    public int tradeId { get; set; }
    [Parameter]
    public int userId { get; set; }

    private Task<AuthorizationResult> authorization;

    [CascadingParameter]
    private Task<AuthenticationState> authenticationStateTask { get; set; }
    private Need4Protocol.User user { get; set; }

    protected override void OnInitialized()
    {
        base.OnInitialized();
    }

    protected override void OnParametersSet()
    {
        var tradeClient = Need4Service.GetTradeClient();
        user = Utility.GetUser();
        TradeUserRequest tradeUserRequest = user != null ?
            new TradeUserRequest { AuthenticatedUserId = user.Id, TradeId = tradeId } :
            new TradeUserRequest { UnauthenticatedUser = new Empty(), TradeId = tradeId };

        var permissions = tradeClient.CheckPermissions(tradeUserRequest);

        var requirements = new List<IAuthorizationRequirement> { new Helpers.JoinTradeRequirement() };
        authorization = AuthorizationService.AuthorizeAsync(HttpContextAccessor.HttpContext.User, new Trade { Id = tradeId }, requirements);
    }
}
